"use strict";

var vm = require("vm"),
    path = require("path"),
    mockedModules = require("../mockedModules");

var bindings = process.binding("natives");

module.exports = function (context) {
  var cache = {};
  return function (id, require) {
    if (cache[id]) {
      return cache[id];
    }

    var code = bindings[id],
        wrappedCode = mockedModules.native_module.wrap(code);

    cache[id] = { exports: {} };

    var __filename = "lib/" + id + ".js";

    var module = vm.runInContext(wrappedCode, context, { filename: __filename });

    module(cache[id].exports, require, cache[id], __filename, path.dirname(__filename));

    return cache[id].exports;
  };
};